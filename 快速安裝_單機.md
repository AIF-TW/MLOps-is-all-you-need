# 快速安裝
<-------尚需大量補充說明------->

此章節說明如何快速安裝此系統，其包含 4 個的功能/服務，分別是
1. 伺服器 `server`：使用 MLflow 與 Prefect 分別提供`排程控制`與`模型版本控制`的服務
2. 開發環境 `ml_experimenter`：建立開發環境需要的基本環境變數與套件清單
3. 工作流程的排程功能 `flow_scheduler`：將排程專案上傳到 `server` 的功能
4. 工作流程的執行服務 `flow_agent`：執行 `server` 指定排程任務的服務

本文提供`多機模式`與`單機模式`兩種部署模式。使用者如果是多人開發團隊，可以將上述 4 個功能/服務分別部署在不同電腦中（`多機模式`），本文將以 `電腦1`、`電腦2`、`電腦3`、`電腦4`指稱 4 個功能/服務分別部署的電腦。而使用者如果是單人使用或是以測試為目的，可以將上述 4 個功能/服務部署在同一台電腦（`單機模式`）。

除此之外，本文針對`工作流程的排程功能`也提供 CPU 和 GPU 兩個版本，使用者可以根據排程任務中的模型需求，自行選擇對應的版本，在後續章節也會說明。

<-------尚需大量補充說明------->

以下我們分成兩種模式做介紹，分別是`單機模式`及`多機模式`，強烈建議讀者第一次使用可以先從單機模式開始安裝，熟悉各模組後再自行改成多機模式安裝。

## 單機模式安裝
<-------尚需補充說明------->

<-------尚需補充說明------->

### 下載檔案與套件

1. 請先在機器上安裝需求套件： [`Git`](https://git-scm.com/book/zh-tw/v2/%E9%96%8B%E5%A7%8B-Git-%E5%AE%89%E8%A3%9D%E6%95%99%E5%AD%B8) 、 [`Docker`](https://www.docker.com/products/docker-desktop/) 、 [`Conda`](https://conda.io/projects/conda/en/latest/user-guide/install/index.html#)
  >如果 `工作流程的執行服務` 需要使用 GPU，請在該電腦安裝 [`NVIDIA Container Toolkit`](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html)

  > 註：如果是 Windows作業系統，建議使用 Bash 執行此章節的指令，比如使用 `Git Bash` 執行。 `Git Bash` 會在下載 `Git` 套件的時候一併下載，使用方式請參考 [如何在VScode 使用 git bash](https://code.visualstudio.com/docs/sourcecontrol/intro-to-git#_git-bash-on-windows)。

2. 開啟終端機，在使用者目錄下載此專案
    > 如果不在使用者目錄下載請特別注意檔案路徑，後續內容需要自行調整檔案路徑
    ```
    # 使用終端機輸入指令，並將此專案存到使用者目錄下的MLOps-is-all-you-need中
    git clone https://github.com/AIF-TW/MLOps-is-all-you-need.git ~/MLOps-is-all-you-need
    ```
3. 進入此專案主要功能的資料夾
    ```
    cd ~/MLOps-is-all-you-need/mlops-sys
    ```
    <details><summary>主要功能檔案結構</summary>
    <p>

    > 請注意有些顯示界面會隱藏 `.env` 和 `.env.local` 檔案
    ```
    ./mlops-sys
    ├── flow_agent
    │   ├── default-agent-pool_ml_distributed_cpu
    │   │   ├── .env
    │   │   ├── Dockerfile
    │   │   ├── docker-compose.yml
    │   │   ├── requirements.txt
    │   │   └── requirements_sys.txt
    │   ├── default-agent-pool_ml_distributed_gpu
    │   │   ├── .env
    │   │   ├── Dockerfile
    │   │   ├── docker-compose.yml
    │   │   ├── requirements.txt
    │   │   └── requirements_sys.txt
    │   ├── default-agent-pool_ml_local_cpu
    │   │   ├── .env
    │   │   ├── Dockerfile
    │   │   ├── docker-compose.yml
    │   │   ├── requirements.txt
    │   │   └── requirements_sys.txt
    │   ├── default-agent-pool_ml_local_gpu
    │   │   ├── .env
    │   │   ├── Dockerfile
    │   │   ├── docker-compose.yml
    │   │   ├── requirements.txt
    │   │   └── requirements_sys.txt
    │   ├── flow_agent_mnist_cpu
    │   │   ├── .env
    │   │   ├── Dockerfile
    │   │   ├── docker-compose.yml
    │   │   ├── requirements.txt
    │   │   └── requirements_sys.txt
    │   ├── flow_agent_pool_ml_cpu
    │   │   ├── Dockerfile
    │   │   ├── docker-compose.yml
    │   │   ├── requirements.txt
    │   │   └── requirements_sys.txt
    │   ├── flow_agent_pool_ml_gpu_0
    │   │   ├── Dockerfile
    │   │   ├── docker-compose.yml
    │   │   ├── requirements.txt
    │   │   └── requirements_sys.txt
    │   └── flow_agent_pool_ml_gpu_1
    │       ├── Dockerfile
    │       ├── docker-compose.yml
    │       ├── requirements.txt
    │       └── requirements_sys.txt
    ├── flow_scheduler
    │   ├── .env
    │   ├── .env.local
    │   ├── Dockerfile
    │   ├── docker-compose-local.yml
    │   ├── docker-compose.yml
    │   ├── requirements_sys.txt
    │   └── setup.py
    ├── ml_experimenter
    │   ├── .env
    │   ├── .env.local
    │   └── requirements_sys.txt
    └── server
        ├── .env
        ├── .env.local
        ├── docker-compose-local.yml
        ├── docker-compose.yml
        ├── init.sh
        └── prefect_setting_s3.py
    ```

    </p>
    </details>

### 單機模式 - 進行安裝
## 一、進行 server功能 安裝

1. 進入到 `server` 資料夾，並啟動伺服器服務
    ```
    cd ~/MLOps-is-all-you-need/mlops-sys/server
    docker-compose -f docker-compose-local.yml --env-file .env.local up --build
    ```

2. 完成後，可以在終端機看到包含以下紀錄，表示各項服務正常啟動
- MinIO (容器名：`minio_s3`)
    ```
    MinIO Object Storage Server
    Copyright: 2015-2023 MinIO, Inc.
    License: GNU AGPLv3 <https://www.gnu.org/licenses/agpl-3.0.html>
    Version: RELEASE.2023-12-14T18-51-57Z (go1.21.5 linux/arm64)
    Status:         1 Online, 0 Offline. 
    S3-API:http://172.19.0.2:9000 http://127.0.0.1:9090
    Console:http://172.19.0.2:9001 http://127.0.0.1:9001

    Documentation:https://min.io/docs/minto/linux/index.html
    Warning: The standard parity is set to 0. This can lead to data loss
    ```
- MLflow (容器名：`mlflow_server`)
    ```
    [2023-11-01 05:43:49 +0000] [33] [INFO] Starting gunicorn 20.1.0
    [2023-11-01 05:43:49 +0000] [33] [INFO] Listening at:http://0.0.0.0:5050(33)
    [2023-11-01 05:43:49 +0000] [33] [INFO] Using worker: sync
    [2023-11-01 05:43:49 +0000] [34] [INFO] Booting worker with pid:34
    [2023-11-01 05:43:49 +0000] [35] [INFO] Booting worker with pid:35
    [2023-11-01 05:43:49 +0000] [36] [INFO] Booting worker with pid:36
    [2023-11-01 05:43:49 +0000] [37] [INFO] Booting worker with pid:37
    ```
- Prefect (容器名：`prefect_server`)
    ```
    Successfully registered 1 block

    ┏━━━━━━━━━━━━━━━━━━━━┓
    ┃ Registered Blocks  ┃
    ┡━━━━━━━━━━━━━━━━━━━━┩
    │ Remote File System │
    └────────────────────┘

    To configure the newly registered blocks, go to the Blocks page in the Prefect 
    UI.


    ___ ___ ___ ___ ___ ___ _____ 
    | _ \ _ \ __| __| __/ __|_   _| 
    |  _/   / _|| _|| _| (__  | |  
    |_| |_|_\___|_| |___\___| |_|  

    Configure Prefect to communicate with the server with:

        prefect config set PREFECT_API_URL=http://0.0.0.0:4200/api

    View the API reference documentation at http://0.0.0.0:4200/docs

    Check out the dashboard at http://0.0.0.0:4200
    ```
- Postgres (容器名：`postgres_db`)
    ```
    PostgreSQL Database directory appears to contain a database; Skipping initialization

    2023-11-13 08:30:16.122 UTC [1] LOG:  starting PostgreSQL 15.4 (Debian 15.4-1.pgdg120+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 12.2.0-14) 12.2.0, 64-bit
    2023-11-13 08:30:16.122 UTC [1] LOG:  listening on IPv4 address "0.0.0.0", port 5432
    2023-11-13 08:30:16.122 UTC [1] LOG:  listening on IPv6 address "::", port 5432
    2023-11-13 08:30:16.270 UTC [1] LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432"
    2023-11-13 08:30:16.518 UTC [29] LOG:  database system was shut down at 2023-11-13 08:29:54 UTC
    2023-11-13 08:30:16.688 UTC [1] LOG:  database system is ready to accept connections
    ```

4. 若有看到以上的成功訊息後，接著可以透過在瀏覽器輸入對應的網址，開始使用以下 GUI 的服務

    > 瀏覽器建議使用 Google Chrome 或是 Microsoft Edge

- MinIO (網址: `http://localhost:9001`，帳號：`admin`，密碼：`adminsecretkey`)

![minio_s3_success_ui](img/minio_s3_success_ui.png)
- MLflow (網址: `http://localhost:5050`)

![mlflow_server_success_ui](img/mlflow_server_success_ui.png)
- Prefect (網址: `http://localhost:4200`)

![prefect_server_success_ui](img/prefect_server_success_ui.png)



### 二、進行 開發環境 ML Experimenter 安裝

<-------尚需補充說明------->
為何需要建這個環境
<-------尚需補充說明------->

> 請開啟新的終端機環境執行本小節的指令

1. `ml_experimenter` 包含建置開發環境需要的檔案，為確保開發環境獨立，我們先利用 conda 建立一個獨立開發環境 `mlops`，並進入該環境
    ```
    # 使用 Git Bash 的 windows 用戶需額外執行下列程式碼，才能正常使用 conda
    source activate
    ```

    ```
    conda create -n mlops python=3.10 -y    # 建立獨立開發環境
    conda activate mlops                    # 進入該開發環境
    ```
2. 下載需要的 Python 套件
    > 註：每個新的獨立環境都要重新下載一次
    ```
    cd ~/MLOps-is-all-you-need/mlops-sys/ml_experimenter
    pip install -r requirements_sys.txt
    ```
3. 建立一個專案資料夾以及在底下建立開發資料夾 `dev` ，並進入此開發資料夾。此處以 [projects/quick-start/dev](../quick_start/dev)為例
    ```
    cd ~/MLOps-is-all-you-need/projects/quick_start/dev
    ```

4. 接著設定環境變數
    - 將專案名稱寫進 [`mlops-sys/ml_experimenter/.env.local`](../../mlops-sys/ml_experimenter/.env.local)，並存檔
    ```
    PROJECT_NAME='my-project'  # 取消註解，並填入專案名稱
    ```

5. [可選擇] 在此開發資料夾中，可以透過初始化 Git 與 DVC 啟用程式碼與資料版本控制服務 
    <details><summary>程式碼</summary>
    <p>

    ```
    source ~/MLOps-is-all-you-need/mlops-sys/ml_experimenter/.env.local
    git init
    dvc init
    dvc remote add -f minio_s3 ${MINIO_S3_PROJECT_BUCKET}
    dvc remote modify minio_s3 endpointurl ${MLFLOW_S3_ENDPOINT_URL}
    ```

6. 最後我們只需要在 `.py` 中，透過加入下方程式碼導入環境變數，就能使用 MLflow 套件做模型版本控制了。
    ```
    from dotenv import load_dotenv

    load_dotenv('~/MLOps-is-all-you-need/mlops-sys/ml_experimenter/.env.local')
    ```
    > 程式碼範例請參考 [projects/quick_start/dev/experiment.py](../quick_start/dev/experiment.py) 

    > 更多細節說明請參考 [mnist 章節](../mnist/readme.md)



### 三、進行 排程功能 Flow Scheduler 安裝
> 請開啟新的終端機環境執行本小節的指令

1. 要幫專案建立排程，請在專案資料夾底下建立排程資料夾 `flow` ，並將開發資料夾 `dev` 的檔案複製到`flow` 中，以及將複製到 `flow` 的主要 `.py` 檔加入 Prefect 的排程功能。加入 Prefect 排程設定的方式，主要是在 Python 函式中加入 Prefect 裝飾器 (decorator)，例如：
    ```
    from prefect import flow, task

    @task()  # 設定任務
    def task1():
        pass

    @flow()  # 將任務串接成排程
    def main():
        task1()

    if __name__ == "__main__":
        main()
    ```
    > `flow` 底下務必存放 `requirements.txt` ，且其內容包含所有用到的套件，並建議附上版本

    > 設定完排程的 `.py` 請參考 [projects/quick_start/flow/prefect_flow.py](../quick_start/flow/prefect_flow.py)

    > 更多細節說明請參考 quick-start 章節

2. 接著我們需在 `flow` 底下建立 `config` 資料夾，並在底下存放排程設定檔 `flow.yml`。 `flow.yml` 的存放檔案結構與參數設定格式請參考 [projects/quick_start/flow/config/flow.yml](../quick_start/flow/config/flow.yml) 。

3. 在執行`工作流程的排程功能`前我們還需要設定該功能要抓取的 `flow` 路徑，以及多機模式需要設定 `SERVER_IP`
    - 單機模式：在 [mlops-sys/flow_scheduler/.env.local](../../mlops-sys/flow_scheduler/.env.local) 中加入 `flow` 路徑，然後存檔。此處以 quick_start 為例：
    ```
    FLOW_DIR = '~/MLOps-is-all-you-need/projects/quick_start/flow' # 取消註解，並設定flow 絕對路徑

    # 相對路徑寫法: 以 .env.local 位置為 root
    # FLOW_DIR = '../../projects/quick_start/flow'
    ```

2.  設定完排程專案後，我們就可以透過 `工作流程的排程功能` 將專案上傳到 `Server` 的排程序列中了

    ```
    cd ~/MLOps-is-all-you-need/mlops-sys/flow_scheduler
    docker-compose -f docker-compose-local.yml --env-file .env.local up --build
    ```

2. 完成後會顯示以下紀錄，表示範例專案已經成功上傳到 Prefect 排程服務
    ```
    Work pool named 'default-agent-pool' already exists. Please try creating your work pool again with a different name.
    Found flow 'main'
    Default '.prefectignore' file written to /root/flows/.prefectignore
    Deployment YAML created at '/root/flows/main-deployment.yml'.
    Successfully uploaded 8 files to s3://prefect/main/model_training
    Deployment 'main/model_training' successfully created with id
    'b84cb77c-9a5b-4575-b603-4d95f84d0e3c'

    To execute flow runs from this deployment, start an agent that pulls work from
    the 'default-agent-pool' work pool:
    $ prefect agent start -p 'default-agent-pool'
    ```

3. 同時也可以在 Prefect 的 GUI 介面看到新加入的排程

![flow_scheduler_success_ui](img/flow_scheduler_success_ui.png)
